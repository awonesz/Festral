import disnake
from disnake.ext import commands
import sqlite3
import asyncio

db = sqlite3.connect('character.db')
cursor = db.cursor()

FACULTY_EMOJIS = {
    "–ì—Ä–∏—Ñ—Ñ–∏–Ω–¥–æ—Ä": "ü¶Å",
    "–°–ª–∏–∑–µ—Ä–∏–Ω": "üêç",
    "–ü—É—Ñ—Ñ–µ–Ω–¥—É–π": "ü¶°",
    "–ö–æ–≥—Ç–µ–≤—Ä–∞–Ω": "ü¶Ö" 
}

class PaginationView(disnake.ui.View):
    current_page : int = 1
    sep : int = 5

    def __init__(self, author_id: int, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.author_id = author_id  # –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –≤—ã–∑–≤–∞–≤—à–µ–≥–æ –∫–æ–º–∞–Ω–¥—É

    async def send(self, inter: disnake.Interaction):
        await inter.response.send_message(view=self)
        self.message = await inter.original_message()
        await self.update_message(self.data[:self.sep])

    def create_embed(self, data):
        total_page = (len(self.data) + self.sep - 1) // self.sep
        embed = disnake.Embed(title="ü™Ñ –ü—Ä–æ—Ñ–∏–ª–∏ –ü–µ—Ä—Å–æ–Ω–∞–∂–µ–π", colour=0x2B2933)
        for item in data:
            name = item[1]
            age = item[2]
            faculty = item[3]
            emoji = FACULTY_EMOJIS.get(faculty)
            embed.add_field(name=f'{name}, *{age}*', value=f"{emoji} {faculty}", inline=False)
        embed.set_footer(text=f'–°—Ç—Ä–∞–Ω–∏—Ü–∞ {self.current_page} –∏–∑ {total_page}')
        return embed

    async def update_message(self, data):
        self.update_buttons()
        await self.message.edit(embed=self.create_embed(data), view=self)

    def update_buttons(self):
        total_page = (len(self.data) + self.sep - 1) // self.sep
        if self.current_page == 1:
            self.prev_button.disabled = True
            self.prev_button.style = disnake.ButtonStyle.gray
        else: 
            self.prev_button.disabled = False
            self.prev_button.style = disnake.ButtonStyle.primary
        if self.current_page == total_page:
            self.next_button.disabled = True
            self.next_button.style = disnake.ButtonStyle.gray
        else: 
            self.next_button.disabled = False
            self.next_button.style = disnake.ButtonStyle.primary

    def get_current_page_data(self):
        from_item = (self.current_page - 1) * self.sep
        until_item = self.current_page * self.sep
        return self.data[from_item:until_item]

    @disnake.ui.button(label="‚¨ÖÔ∏è", style=disnake.ButtonStyle.primary)
    async def prev_button(self, button: disnake.ui.Button, interaction: disnake.Interaction):
        if interaction.user.id != self.author_id:
            await interaction.response.send_message("–í–∞–º –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ.", ephemeral=True)
            return
        await interaction.response.defer()
        self.current_page -= 1
        await self.update_message(self.get_current_page_data())

    @disnake.ui.button(label="‚û°Ô∏è", style=disnake.ButtonStyle.primary)
    async def next_button(self, button: disnake.ui.Button, interaction: disnake.Interaction):
        if interaction.user.id != self.author_id:
            await interaction.response.send_message("–í–∞–º –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ.", ephemeral=True)
            return
        await interaction.response.defer()
        self.current_page += 1
        await self.update_message(self.get_current_page_data())


class Character(commands.Cog):
    def __init__(self, client):
        self.client = client

    @commands.slash_command(name='profiles', description='–í—ã–≤–µ–¥–∏—Ç–µ –≤–µ—Å—å —Å–ø–∏—Å–æ–∫ –ø—Ä–æ—Ñ–∏–ª–µ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ')
    async def profiles(self, inter: disnake.ApplicationCommandInteraction):
        cursor.execute('SELECT * FROM character')
        data = cursor.fetchall()
        pagination_view = PaginationView(author_id=inter.author.id, timeout=None)
        pagination_view.data = data
        await pagination_view.send(inter)

        def check(m: disnake.Message):
            return m.author.id == inter.author.id and m.channel.id == inter.channel.id

        try:
            message = await self.client.wait_for("message", check=check, timeout=60.0)
            character_name = message.content.strip()

            cursor.execute('SELECT * FROM character WHERE name = ?', (character_name,))
            character = cursor.fetchone()

            if character:
                name, age, faculty, picture = character[1], character[2], character[3], character[4]
                emoji = FACULTY_EMOJIS.get(faculty)
                embed = disnake.Embed(
                    title=f"ü™Ñ Festral | –ü—Ä–æ—Ñ–∏–ª—å",
                    description=f"**–ò–º—è:** {name} \n **–í–æ–∑—Ä–∞—Å—Ç:** {age}\n**–§–∞–∫—É–ª—å—Ç–µ—Ç:** {emoji} {faculty}",
                    inline=True,
                    colour=0x2B2933,
                )
                embed.set_thumbnail(picture)
                await pagination_view.message.edit(embed=embed, view=None)
            else:
                await inter.followup.send(f"–ü–µ—Ä—Å–æ–Ω–∞–∂ —Å –∏–º–µ–Ω–µ–º `{character_name}` –Ω–µ –Ω–∞–π–¥–µ–Ω.", ephemeral=True)

        except asyncio.TimeoutError:
            await inter.followup.send("–í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.", ephemeral=True)


def setup(client):
    client.add_cog(Character(client))